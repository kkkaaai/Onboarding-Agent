<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Onboarding Assistant</title>
    <link rel="stylesheet" href="styles/chatbot.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Welcome to Raspberry Coffee! ‚òï</h1>
            <p>Meet your AI onboarding assistant who can help you navigate our team, understand our culture, and answer your questions about joining Raspberry Coffee.</p>
        </header>

        <div class="chat-container">
            <video id="persona-video" autoplay playsinline></video>
            <div id="status" class="status">
                <span class="status-dot"></span>
                <span id="status-text">Initializing...</span>
            </div>
        </div>

        <div class="instructions">
            <h3>How to interact:</h3>
            <ul>
                <li>üé§ <strong>Speak naturally</strong> - Your assistant will listen and respond</li>
                <li>‚ùì Ask about our team, company values, projects, or who to contact</li>
                <li>üçá Learn about our design-led philosophy and Bloom OS ecosystem</li>
                <li>üìö Powered by Raspberry Coffee's knowledge base</li>
            </ul>
        </div>
    </div>

    <script type="module">
        import { createClient } from "https://esm.sh/@anam-ai/js-sdk@latest";
        import { CONFIG } from "./config.js?v=4";

        const videoElement = document.getElementById("persona-video");
        const statusElement = document.getElementById("status-text");
        const statusDot = document.querySelector(".status-dot");

        function updateStatus(text, state = 'loading') {
            statusElement.textContent = text;
            statusDot.className = `status-dot ${state}`;
        }

        async function createSessionToken() {
            const response = await fetch("https://api.anam.ai/v1/auth/session-token", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${CONFIG.API_KEY}`,
                },
                body: JSON.stringify({
                    personaConfig: CONFIG.PERSONA_CONFIG,
                }),
            });

            if (!response.ok) {
                const error = await response.text();
                console.error("API Response Status:", response.status);
                console.error("API Error:", error);
                throw new Error(`Failed to create session (${response.status}): ${error}`);
            }

            const data = await response.json();
            return data.sessionToken;
        }

        async function startChat() {
            try {
                updateStatus("Creating session...", 'loading');

                const sessionToken = await createSessionToken();
                updateStatus("Connecting to your assistant...", 'loading');

                const anamClient = createClient(sessionToken);
                
                // Listen to connection events
                anamClient.addListener("connectionStateChanged", (state) => {
                    console.log("Connection state:", state);
                    if (state === "connected") {
                        updateStatus("Connected! Start speaking to ask questions", 'connected');
                    }
                });

                // Listen to persona speaking events
                anamClient.addListener("personaStartedSpeaking", () => {
                    updateStatus("Assistant is speaking...", 'speaking');
                });

                anamClient.addListener("personaStoppedSpeaking", () => {
                    updateStatus("Listening... (speak to ask a question)", 'connected');
                });

                // Listen for errors
                anamClient.addListener("error", (error) => {
                    console.error("Anam error:", error);
                    updateStatus(`Error: ${error.message}`, 'error');
                });

                await anamClient.streamToVideoElement("persona-video");

            } catch (error) {
                console.error("Failed to start chat:", error);
                console.error("Error details:", error.message);
                updateStatus(
                    `Failed to connect: ${error.message}. Check browser console for details.`,
                    'error'
                );
            }
        }

        // Auto-start when page loads
        if (CONFIG.API_KEY === "YOUR_API_KEY_HERE") {
            updateStatus("‚ö†Ô∏è Please add your API key in config.js", 'error');
        } else {
            startChat();
        }
    </script>
</body>
</html>

