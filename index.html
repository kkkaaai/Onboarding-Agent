<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Onboarding Assistant</title>
    <link rel="stylesheet" href="styles/chatbot.css">
</head>
<body>
    <div class="chatbot-wrapper">
        <div class="chatbot-header">
            <div class="header-content">
                <div class="avatar-badge">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="12" r="10" fill="url(#gradient1)"/>
                        <path d="M12 6C9.79 6 8 7.79 8 10C8 12.21 9.79 14 12 14C14.21 14 16 12.21 16 10C16 7.79 14.21 6 12 6Z" fill="white"/>
                        <path d="M12 15C8.13 15 5 16.57 5 18.5V20H19V18.5C19 16.57 15.87 15 12 15Z" fill="white"/>
                    </svg>
                    <defs>
                        <linearGradient id="gradient1" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                </div>
                <div class="header-text">
                    <h2>AI Onboarding Assistant</h2>
                    <p id="assistant-subtitle">Ready to help you get started</p>
                </div>
            </div>
        </div>

        <div class="video-container">
            <div class="video-frame">
                <video id="persona-video" autoplay playsinline></video>
                <div class="video-overlay" id="video-overlay">
                    <div class="pulse-circle"></div>
                    <svg class="microphone-icon" width="48" height="48" viewBox="0 0 24 24" fill="white">
                        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                        <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                    </svg>
                    <p class="overlay-text">Allow microphone to start</p>
                </div>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-indicator">
                <span class="status-dot" id="status-dot"></span>
                <span class="status-text" id="status-text">Initializing...</span>
            </div>
            <div class="quick-tips">
                <button class="tip-btn" onclick="showTip('manager')">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 8a3 3 0 100-6 3 3 0 000 6zM8 9a5 5 0 00-5 5v1h10v-1a5 5 0 00-5-5z"/>
                    </svg>
                    My Manager
                </button>
                <button class="tip-btn" onclick="showTip('team')">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M5 8a3 3 0 100-6 3 3 0 000 6zm6 0a3 3 0 100-6 3 3 0 000 6zm-6 1a5 5 0 00-5 5v1h10v-1a5 5 0 00-5-5zm6 0a5 5 0 00-5 5v1h10v-1a5 5 0 00-5-5z"/>
                    </svg>
                    My Team
                </button>
                <button class="tip-btn" onclick="showTip('tasks')">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M13 2H3a1 1 0 00-1 1v10a1 1 0 001 1h10a1 1 0 001-1V3a1 1 0 00-1-1zM5 11L3 9l1-1 1 1 3-3 1 1-4 4z"/>
                    </svg>
                    Tasks
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from "https://esm.sh/@anam-ai/js-sdk@latest";
        import { CONFIG } from "./config.js?v=5";

        const videoElement = document.getElementById("persona-video");
        const statusElement = document.getElementById("status-text");
        const statusDot = document.getElementById("status-dot");
        const videoOverlay = document.getElementById("video-overlay");
        const subtitleElement = document.getElementById("assistant-subtitle");

        function updateStatus(text, state = 'loading') {
            statusElement.textContent = text;
            statusDot.className = `status-dot ${state}`;
            
            // Update subtitle
            if (state === 'connected') {
                subtitleElement.textContent = 'ðŸŽ™ï¸ Listening...';
            } else if (state === 'speaking') {
                subtitleElement.textContent = 'ðŸ—£ï¸ Speaking...';
            } else if (state === 'error') {
                subtitleElement.textContent = 'âš ï¸ Connection issue';
            }
        }

        async function createSessionToken() {
            const response = await fetch("https://api.anam.ai/v1/auth/session-token", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${CONFIG.API_KEY}`,
                },
                body: JSON.stringify({
                    personaConfig: CONFIG.PERSONA_CONFIG,
                }),
            });

            if (!response.ok) {
                const error = await response.text();
                console.error("API Response Status:", response.status);
                console.error("API Error:", error);
                throw new Error(`Failed to create session (${response.status}): ${error}`);
            }

            const data = await response.json();
            return data.sessionToken;
        }

        async function startChat() {
            try {
                updateStatus("Initializing AI assistant...", 'loading');

                const sessionToken = await createSessionToken();
                updateStatus("Connecting...", 'loading');

                const anamClient = createClient(sessionToken);
                
                // Listen to connection events
                anamClient.addListener("connectionStateChanged", (state) => {
                    console.log("Connection state:", state);
                    if (state === "connected") {
                        updateStatus("Ready to chat!", 'connected');
                        // Hide overlay when connected
                        if (videoOverlay) {
                            videoOverlay.style.opacity = '0';
                            setTimeout(() => {
                                videoOverlay.style.display = 'none';
                            }, 300);
                        }
                    }
                });

                // Listen to persona speaking events
                anamClient.addListener("personaStartedSpeaking", () => {
                    updateStatus("Assistant is speaking...", 'speaking');
                });

                anamClient.addListener("personaStoppedSpeaking", () => {
                    updateStatus("Ready to chat!", 'connected');
                });

                // Listen for errors
                anamClient.addListener("error", (error) => {
                    console.error("Anam error:", error);
                    updateStatus(`${error.message}`, 'error');
                });

                await anamClient.streamToVideoElement("persona-video");

            } catch (error) {
                console.error("Failed to start chat:", error);
                updateStatus(error.message, 'error');
            }
        }

        // Quick tip buttons
        window.showTip = function(type) {
            const tips = {
                'manager': "Who is my manager?",
                'team': "Tell me about my team",
                'tasks': "What should I do on my first day?"
            };
            console.log("Suggested question:", tips[type]);
            // You could potentially send this to Anam if there's a text input method
        };

        // Auto-start when page loads
        if (CONFIG.API_KEY === "YOUR_API_KEY_HERE") {
            updateStatus("Please add your API key in config.js", 'error');
        } else {
            startChat();
        }
    </script>
</body>
</html>

